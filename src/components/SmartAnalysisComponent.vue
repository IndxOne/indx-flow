<template>
  <div class="smart-analysis">
    <!-- Input utilisateur -->
    <div class="mb-6">
      <textarea 
        v-model="userInput"
        @input="onInputChange"
        placeholder="D√©crivez votre activit√© en quelques mots..."
        class="w-full h-32 p-4 border-2 border-gray-200 rounded-xl resize-none focus:border-indigo-500 focus:outline-none"
        maxlength="500"
      />
      <div class="text-right mt-2">
        <span class="text-xs text-gray-400">{{ userInput.length }}/500</span>
      </div>
    </div>

    <!-- Bouton d'analyse intelligent -->
    <button 
      @click="startSmartAnalysis"
      :disabled="!canAnalyze"
      class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-4 px-8 rounded-xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:from-indigo-600 hover:to-purple-700 transition-all duration-200"
    >
      {{ analyzeButtonText }}
    </button>

    <!-- Progression d'analyse -->
    <div v-if="isAnalyzing" class="mt-6">
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center mb-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-4"></div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">{{ analysisStep.title }}</h3>
            <p class="text-sm text-gray-600">{{ analysisStep.description }}</p>
          </div>
        </div>
        
        <!-- Barre de progression -->
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div 
            class="bg-indigo-600 h-2 rounded-full transition-all duration-500"
            :style="{ width: `${analysisProgress}%` }"
          ></div>
        </div>
        
        <!-- D√©tails techniques (optionnel) -->
        <div v-if="showTechnicalDetails" class="mt-4 text-xs text-gray-500">
          <p>Mode: {{ analysisMode }} | Confidence: {{ confidence }}% | Source: {{ analysisSource }}</p>
        </div>
      </div>
    </div>

    <!-- R√©sultats d'analyse -->
    <div v-if="analysisComplete && !isAnalyzing" class="mt-6">
      <div class="bg-green-50 rounded-2xl p-6 mb-6">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-bold text-gray-900">Analyse {{ analysisQualityLabel }} termin√©e !</h3>
            <p class="text-sm text-gray-600">
              {{ analysisResultSummary }}
            </p>
          </div>
        </div>
      </div>

      <!-- Options de structures -->
      <div class="space-y-4">
        <div 
          v-for="option in structureOptions" 
          :key="option.id"
          class="card-hover bg-white rounded-2xl shadow-lg border border-gray-200 p-6 cursor-pointer"
          :class="{ 'border-indigo-500 bg-indigo-50': option.recommended }"
          @click="selectStructure(option)"
        >
          <div class="flex items-start">
            <div class="flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center mr-4"
                 :class="option.recommended ? 'bg-indigo-100' : 'bg-gray-100'">
              <span class="text-2xl">{{ option.icon }}</span>
            </div>
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">{{ option.title }}</h3>
                <span v-if="option.recommended" class="ml-2 bg-indigo-500 text-white text-xs px-2 py-1 rounded-full">
                  Recommand√©
                </span>
                <span class="ml-2 text-sm text-gray-500">({{ option.confidence }}% correspondance)</span>
              </div>
              <p class="text-gray-600 mb-4">{{ option.description }}</p>
              <div class="text-sm text-gray-500 mb-4">
                <strong>Structure:</strong> {{ option.structure.join(' ‚Üí ') }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useFormStore } from '../stores/formStore.js'
import { contextApi } from '../services/api.js'

// Stores
const formStore = useFormStore()

// √âtat r√©actif
const userInput = ref('')
const isAnalyzing = ref(false)
const analysisComplete = ref(false)
const analysisProgress = ref(0)
const analysisMode = ref('hybrid') // 'local', 'ai', 'hybrid'
const analysisSource = ref('')
const confidence = ref(0)
const analysisResult = ref(null)
const structureOptions = ref([])

// √âtat des √©tapes d'analyse
const analysisSteps = {
  local: [
    { title: '‚ö° Analyse locale', description: 'Traitement instantan√© de votre description' },
    { title: '‚úÖ Termin√©', description: 'R√©sultats g√©n√©r√©s localement' }
  ],
  ai: [
    { title: 'üîç Analyse contextuelle', description: 'Extraction des mots-cl√©s et concepts m√©tier' },
    { title: 'ü§ñ IA Claude', description: 'G√©n√©ration de recommandations personnalis√©es' },
    { title: 'üéØ Optimisation', description: 'Adaptation des structures √† votre profil' },
    { title: '‚ú® Finalisation', description: 'Pr√©paration de vos options personnalis√©es' }
  ],
  hybrid: [
    { title: '‚ö° Pr√©-analyse', description: 'Analyse locale rapide en cours' },
    { title: 'ü§ñ Analyse IA', description: 'Am√©lioration de la pr√©cision avec l\'IA' },
    { title: 'üéØ Fusion intelligente', description: 'Combinaison des meilleurs r√©sultats' },
    { title: '‚úÖ Optimisation', description: 'Finalisation de vos recommandations' }
  ]
}

const currentStepIndex = ref(0)
const showTechnicalDetails = ref(false) // Pour debug

// Computed
const canAnalyze = computed(() => userInput.value.length >= 10)

const analyzeButtonText = computed(() => {
  if (isAnalyzing.value) return 'Analyse en cours...'
  if (userInput.value.length < 10) return 'Saisissez au moins 10 caract√®res'
  if (userInput.value.length < 50) return '‚ö° Analyse rapide'
  if (userInput.value.length < 150) return 'üîç Analyse standard'
  return 'ü§ñ Analyse IA approfondie'
})

const analysisStep = computed(() => {
  const steps = analysisSteps[analysisMode.value] || []
  return steps[currentStepIndex.value] || { title: 'Analyse', description: 'En cours...' }
})

const analysisQualityLabel = computed(() => {
  switch (analysisSource.value) {
    case 'local': return 'rapide'
    case 'ai': return 'approfondie'
    case 'hybrid': return 'optimis√©e'
    default: return 'intelligente'
  }
})

const analysisResultSummary = computed(() => {
  if (!analysisResult.value) return ''
  
  const mode = analysisSource.value
  const conf = confidence.value
  
  if (mode === 'local') {
    return `Analyse locale effectu√©e en moins de 100ms avec ${conf}% de confiance.`
  } else if (mode === 'ai') {
    return `Analyse IA Claude compl√®te avec ${conf}% de confiance et contexte d√©taill√©.`
  } else {
    return `Analyse hybride optimisant vitesse et pr√©cision avec ${conf}% de confiance.`
  }
})

// M√©thodes
const onInputChange = () => {
  // Reset si l'utilisateur modifie apr√®s analyse
  if (analysisComplete.value) {
    analysisComplete.value = false
    structureOptions.value = []
  }
}

const determineAnalysisMode = (text) => {
  // Logique de d√©cision intelligente
  if (text.length < 50) {
    return 'local'
  } else if (text.length > 200 || /(?:consultant|manager|technical|complex|multiple|integration)/i.test(text)) {
    return 'ai'
  } else {
    return 'hybrid'
  }
}

const startSmartAnalysis = async () => {
  isAnalyzing.value = true
  analysisComplete.value = false
  analysisProgress.value = 0
  currentStepIndex.value = 0
  
  // D√©terminer le mode d'analyse optimal
  analysisMode.value = determineAnalysisMode(userInput.value)
  
  try {
    // Progression simul√©e r√©aliste
    await runAnalysisWithProgress()
    
    // Finaliser
    analysisComplete.value = true
    isAnalyzing.value = false
    
  } catch (error) {
    console.error('Erreur analyse:', error)
    isAnalyzing.value = false
    // TODO: Gestion d'erreur UX
  }
}

const runAnalysisWithProgress = async () => {
  const steps = analysisSteps[analysisMode.value]
  const stepDuration = analysisMode.value === 'local' ? 200 : 800
  
  for (let i = 0; i < steps.length; i++) {
    currentStepIndex.value = i
    analysisProgress.value = ((i + 1) / steps.length) * 100
    
    // Simulation progression
    await new Promise(resolve => setTimeout(resolve, stepDuration))
    
    // Analyse r√©elle √† la derni√®re √©tape
    if (i === steps.length - 1) {
      await performActualAnalysis()
    }
  }
}

const performActualAnalysis = async () => {
  try {
    let result
    
    if (analysisMode.value === 'local') {
      // Analyse locale uniquement
      result = await contextApi.analyzeLocal(userInput.value)
      analysisSource.value = 'local'
    } else if (analysisMode.value === 'ai') {
      // Analyse IA uniquement
      result = await contextApi.analyzeAI(userInput.value)
      analysisSource.value = 'ai'
    } else {
      // Analyse hybride
      result = await contextApi.analyzeHybrid(userInput.value)
      analysisSource.value = result.source || 'hybrid'
    }
    
    if (result.success) {
      analysisResult.value = result.analysis
      confidence.value = result.analysis.confidence || 75
      generateStructureOptions(result.analysis)
    } else {
      throw new Error(result.error || 'Analyse √©chou√©e')
    }
    
  } catch (error) {
    console.error('Erreur analyse:', error)
    // Fallback sur analyse locale
    const fallbackResult = await contextApi.analyzeLocal(userInput.value)
    analysisResult.value = fallbackResult.analysis
    analysisSource.value = 'local_fallback'
    confidence.value = fallbackResult.analysis.confidence || 60
    generateStructureOptions(fallbackResult.analysis)
  }
}

const generateStructureOptions = (analysis) => {
  // G√©n√©rer 2-3 options de structures bas√©es sur l'analyse
  const options = []
  
  // Option principale (recommand√©e)
  options.push({
    id: 'primary',
    title: getStructureTitle(analysis.detectedContext),
    icon: getStructureIcon(analysis.detectedContext),
    description: getStructureDescription(analysis.detectedContext),
    structure: getStructureColumns(analysis.detectedContext),
    confidence: analysis.confidence,
    recommended: true,
    contextType: analysis.detectedContext
  })
  
  // Option alternative si contextes multiples
  if (analysis.detectedContexts && analysis.detectedContexts.length > 1) {
    const secondaryContext = analysis.detectedContexts[1]
    options.push({
      id: 'secondary',
      title: getStructureTitle(secondaryContext.type),
      icon: getStructureIcon(secondaryContext.type),
      description: getStructureDescription(secondaryContext.type),
      structure: getStructureColumns(secondaryContext.type),
      confidence: secondaryContext.confidence,
      recommended: false,
      contextType: secondaryContext.type
    })
  }
  
  // Option personnalis√©e
  options.push({
    id: 'custom',
    title: 'Structure Personnalis√©e',
    icon: 'üé®',
    description: 'Cr√©ez votre propre organisation de A √† Z selon vos besoins sp√©cifiques.',
    structure: ['Colonne 1', 'Colonne 2', 'Colonne 3', 'Colonne 4'],
    confidence: 100,
    recommended: false,
    contextType: 'CUSTOM'
  })
  
  structureOptions.value = options
}

const selectStructure = (option) => {
  // √âmettre l'√©v√©nement de s√©lection vers le parent
  emit('structure-selected', {
    option,
    analysisResult: analysisResult.value,
    userInput: userInput.value
  })
}

// Helpers pour g√©n√©ration options
const getStructureTitle = (contextType) => {
  const titles = {
    'CLIENT_BASED': 'Organisation par Clients',
    'TEMPORAL': 'Organisation par Sprints',
    'PHASED': 'Organisation par Phases',
    'PROCESS_BASED': 'Organisation par Processus',
    'RESOURCE_BASED': 'Organisation par √âquipes',
    'VERSIONED': 'Organisation par Versions'
  }
  return titles[contextType] || 'Organisation Standard'
}

const getStructureIcon = (contextType) => {
  const icons = {
    'CLIENT_BASED': 'üè¢',
    'TEMPORAL': '‚ö°',
    'PHASED': 'üìä',
    'PROCESS_BASED': 'üîÑ',
    'RESOURCE_BASED': 'üë•',
    'VERSIONED': 'üöÄ'
  }
  return icons[contextType] || 'üìã'
}

const getStructureDescription = (contextType) => {
  const descriptions = {
    'CLIENT_BASED': 'Id√©al pour g√©rer plusieurs clients avec des projets distincts. Chaque client a son espace d√©di√©.',
    'TEMPORAL': 'Perfect pour cycles de d√©veloppement agiles avec sprints d√©finis et backlog organis√©.',
    'PHASED': 'Con√ßu pour projets s√©quentiels avec phases distinctes et livrables pr√©cis.',
    'PROCESS_BASED': 'Optimis√© pour workflows avec √©tapes de validation et processus standardis√©s.',
    'RESOURCE_BASED': 'Pens√© pour coordination d\'√©quipes et allocation optimale des ressources.',
    'VERSIONED': 'Adapt√© au d√©veloppement produit avec releases et versions planifi√©es.'
  }
  return descriptions[contextType] || 'Structure flexible adaptable √† vos besoins.'
}

const getStructureColumns = (contextType) => {
  const columns = {
    'CLIENT_BASED': ['üéØ Prospects', 'üè¢ Client A', 'üè≠ Client B', 'üì¶ Termin√©s'],
    'TEMPORAL': ['üìã Backlog', '‚ö° Sprint Actuel', 'üîÑ En Review', '‚úÖ Termin√©'],
    'PHASED': ['üîç Analyse', '‚öôÔ∏è R√©alisation', 'üß™ Tests', 'üöÄ D√©ploiement'],
    'PROCESS_BASED': ['üì• Nouveau', 'üîÑ En cours', 'üëÄ Validation', '‚úÖ Termin√©'],
    'RESOURCE_BASED': ['üë• √âquipe A', 'üë®‚Äçüíª √âquipe B', 'üÜò Support', 'üèÅ Termin√©'],
    'VERSIONED': ['üí° Id√©es', 'üöß v1.0', 'üîÑ v1.1', 'üöÄ Released']
  }
  return columns[contextType] || ['√Ä faire', 'En cours', 'Review', 'Termin√©']
}

// √âv√©nements
const emit = defineEmits(['structure-selected'])

// Watch pour debugging
watch(analysisMode, (newMode) => {
  console.log('üîç Mode d\'analyse:', newMode)
})

watch(analysisProgress, (newProgress) => {
  console.log('üìä Progression:', `${newProgress}%`)
})
</script>

<style scoped>
.card-hover {
  transition: all 0.3s ease;
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
</style>